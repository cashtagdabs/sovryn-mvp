# SOVRYN.AI + PRIMEX Copilot Guide

- **Architecture**: Next.js 14 App Router in [app](app) with API routes under [app/api](app/api); Prisma/PostgreSQL models in [prisma/schema.prisma](prisma/schema.prisma); Clerk auth; Stripe billing; AI routing in [app/lib/ai](app/lib/ai); sovereign Ollama/FastAPI backend in [primex-backend](primex-backend).
- **AI routing**: Always go through [app/lib/ai/router.ts](app/lib/ai/router.ts) `chat`/`chatStream` so providers stay centralized; models and pricing live in [app/lib/ai/providers.ts](app/lib/ai/providers.ts) (includes PRIMEX, OpenAI, Anthropic, Groq, Ollama fallback via `OLLAMA_API_URL`).
- **PRIMEX client**: Local sovereign models call the FastAPI orchestrator via `PRIMEX_BACKEND_URL`/`PRIMEX_API_URL`; see [app/lib/ai/providers.ts](app/lib/ai/providers.ts) `getPrimexClient` and [app/lib/ai/primex-provider.ts](app/lib/ai/primex-provider.ts) for clone mapping and health checks.
- **Backend orchestration**: [primex-backend/services/clone-orchestrator.py](primex-backend/services/clone-orchestrator.py) exposes `/invoke`, `/clones`, `/health`, loading clone configs from `primex-backend/config/clones/*.json` and loyalty-core metadata; uses Ollama chat with per-clone temperature. A simplified legacy `/chat` exists in [primex-backend/main.py](primex-backend/main.py).
- **Chat API pattern**: [app/api/chat/route.ts](app/api/chat/route.ts) validates with zod, enforces usage + plan access, creates conversation if absent, stores USER then ASSISTANT messages, and returns the saved assistant payload. For streaming, [app/api/chat/stream/route.ts](app/api/chat/stream/route.ts) emits SSE events (`conversation`, `content`, `done`) and falls back to a demo response when providers are missing.
- **Auth**: Primary auth is Clerk (`auth()`); dev overrides allowed via `x-dev-clerk-id` header or `DEV_CLERK_ID` env in [app/lib/auth.ts](app/lib/auth.ts). Sovereign PRIMEX endpoints gate on `SOVEREIGN_USER_ID` (see [app/api/primex/invoke/route.ts](app/api/primex/invoke/route.ts)).
- **Usage and plans**: Message quotas and model access are enforced via [app/lib/usage.ts](app/lib/usage.ts) and [app/lib/stripe.ts](app/lib/stripe.ts); plans map to allowed models and monthly caps (FREE=100 msgs, PRO/ENTERPRISE/SOVEREIGN unlimited with broader models).
- **Database client**: [app/lib/db.ts](app/lib/db.ts) lazily creates Prisma; in dev without `DATABASE_URL` it falls back to an in-memory mock, so be careful when relying on persistence in local runs.
- **Data model highlights**: Users keyed by Clerk `clerkId`; conversations/messages store roles and models; citations attached to messages; SavedPrompt supports tags and public flag; ConversationLike enforces unique user/conversation pairs; see [prisma/schema.prisma](prisma/schema.prisma).
- **PRIMEX access pattern**: Frontend sovereign routes call `/api/primex/invoke` which forwards to the FastAPI orchestrator; PRIMEX clone map in [app/lib/ai/primex-provider.ts](app/lib/ai/primex-provider.ts) routes `primex-*` model IDs to clone names.
- **Local dev workflow**: Use [scripts/start-local.sh](scripts/start-local.sh) to spin up Ollama (if not running), start FastAPI `services.clone-orchestrator:app` on 8000, then `npm run dev` on 3000 (auto-installs deps/venv). Standard Next scripts: `npm run dev`, `npm run build` (runs `prisma generate`), `npm run lint`.
- **Environment essentials**: `DATABASE_URL`, `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `GROQ_API_KEY`, `PRIMEX_BACKEND_URL` or `PRIMEX_API_URL`, `OLLAMA_API_URL` (ngrok for remote), Clerk keys, Stripe keys (`NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_*`), `SOVEREIGN_USER_ID` for sovereign access.
- **Error handling patterns**: API handlers return JSON with helpful `details` on server errors (see [app/api/chat/route.ts](app/api/chat/route.ts)) and keep streaming endpoints resilient with fallback responses.
- **Billing**: Stripe client-safe config and plan definitions live in [app/lib/stripe.ts](app/lib/stripe.ts); server-side subscription/customer creation is in [app/lib/stripe.server.ts](app/lib/stripe.server.ts) (uses secrets, so keep calls server-side).
- **Content sharing**: Conversations support public sharing and likes (fields in [prisma/schema.prisma](prisma/schema.prisma)); respect `isPublic`, `shareId`, and counters when adding share features.
- **Testing gaps**: No automated test harness present; rely on API routes and in-memory Prisma mock for quick manual checks; remember mock persistence resets between runs.
- **When adding AI features**: Reuse `aiRouter` and persist messages through the conversation pattern; update model availability in `SUBSCRIPTION_PLANS` when adding new model IDs; keep streaming contract (`content` chunks then `done`) stable for the chat UI.
- **When touching backend clones**: Add/update clone config JSONs under `primex-backend/config/clones`, ensure models exist in Ollama, and align clone names with the `cloneMap` in [app/lib/ai/primex-provider.ts](app/lib/ai/primex-provider.ts).
- **Security**: Sovereign mode is for a single owner; loyalty-core and security key are loaded in the FastAPI orchestrator, but frontend still enforces `SOVEREIGN_USER_ID`â€”do not bypass these checks.
