generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Citation {
  id        String   @id
  messageId String
  title     String
  url       String
  snippet   String
  order     Int
  createdAt DateTime @default(now())
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model Conversation {
  id               String             @id
  userId           String
  title            String
  isArchived       Boolean            @default(false)
  isPinned         Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  isPublic         Boolean            @default(false)
  likeCount        Int                @default(0)
  shareId          String?            @unique
  viewCount        Int                @default(0)
  model            String             @default("PRIMEX")
  User             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  ConversationLike ConversationLike[]
  Message          Message[]
  Search           Search[]

  @@index([isPublic])
  @@index([shareId])
  @@index([userId])
}

model ConversationLike {
  id             String       @id
  userId         String
  conversationId String
  createdAt      DateTime     @default(now())
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
  @@index([conversationId])
}

model Message {
  id             String       @id
  conversationId String
  userId         String
  content        String
  tokenCount     Int?
  createdAt      DateTime     @default(now())
  role           String
  model          String?
  Citation       Citation[]
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model SavedPrompt {
  id          String   @id
  userId      String
  title       String
  description String?
  prompt      String
  category    String?
  tags        String
  isPublic    Boolean  @default(false)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  likeCount   Int      @default(0)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isPublic])
  @@index([userId])
}

model Search {
  id             String        @id
  conversationId String?
  userId         String
  query          String
  results        String
  createdAt      DateTime      @default(now())
  Conversation   Conversation? @relation(fields: [conversationId], references: [id])
  User           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                     String    @id
  userId                 String    @unique
  stripeCustomerId       String    @unique
  stripeSubscriptionId   String?
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime
  plan                   String    @default("FREE")
  status                 String    @default("ACTIVE")
  User                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id               String             @id
  clerkId          String             @unique
  email            String             @unique
  name             String?
  avatarUrl        String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  bio              String?
  github           String?
  twitter          String?
  username         String?            @unique
  website          String?
  Conversation     Conversation[]
  ConversationLike ConversationLike[]
  Message          Message[]
  SavedPrompt      SavedPrompt[]
  Search           Search[]
  Subscription     Subscription?
  OAuthConnection  OAuthConnection[]
}

model OAuthConnection {
  id                String   @id
  userId            String
  provider          String   // github, google, dropbox
  accessToken       String
  refreshToken      String?
  providerAccountId String
  providerUsername  String?
  scopes            String?
  expiresAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
}
